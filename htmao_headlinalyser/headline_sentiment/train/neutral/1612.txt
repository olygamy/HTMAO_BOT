Progress and problems as UN climate change talks end with a deal